
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ê³¨í”„ ë¨¸ë‹ˆ ê³„ì‚°ê¸° â€“ ìµœì¢…ë³¸ (ìŠ¤í‚¨ êµ¬ê°„ ìƒ‰ v7 + ì´ íŒŒ/ì´ íƒ€ìˆ˜ + ë¦¬í”„ë ˆì‹œ)</title>
<style>
body { font-family: Arial, sans-serif; margin: 16px; }
table { border-collapse: collapse; width: 100%; max-width: 100%; }
th, td { border: 1px solid #999; padding: 6px; text-align: center; }
input { width: 64px; text-align:center; box-sizing: border-box; }
.name-input { width: 120px; }
.controls { margin-bottom: 10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
.move { font-weight: bold; }
.note { font-size:12px; color:#555; margin-top:4px; }
.pos { color: #0a7; font-weight: bold; }
.neg { color: #d33; font-weight: bold; }
/* ë²„ë”” / ì´ê¸€ ìƒ‰ìƒ */
.birdie { background:#cfefff; }
.eagle  { background:#ffe3b3; }
/* ìŠ¤í‚¨ ë”´ êµ¬ê°„ í•˜ì´ë¼ì´íŠ¸ */
.skinwin { background: #c08dff !important; color:#000; }
/* ë²„íŠ¼ */
button { padding: 6px 12px; cursor: pointer; }
</style>
</head>
<body>

<h2>ê³¨í”„ ë¨¸ë‹ˆ ê³„ì‚°ê¸° (ìµœì¢…ë³¸ â€“ ìŠ¤í‚¨ êµ¬ê°„ ìƒ‰ v7 + ì´ íŒŒ/ì´ íƒ€ìˆ˜ + ë¦¬í”„ë ˆì‹œ)</h2>

<div class="controls">
  í”Œë ˆì´ì–´ ìˆ˜:
  <select id="playerCount" onchange="setupPlayers()">
    <option value="2">2ëª…</option>
    <option value="3">3ëª…</option>
    <option value="4" selected>4ëª…</option>
    <option value="5">5ëª…</option>
  </select>

  ê¸°ë³¸ íƒ€ë‹¹($): <input id="rate" value="2" oninput="calculateGame()">
  ë²„ë””($): <input id="birdie" value="5" oninput="calculateGame()">
  ì´ê¸€($): <input id="eagle" value="20" oninput="calculateGame()">
  ìŠ¤í‚¨($): <input id="skin" value="2" oninput="calculateGame()">

  ìŠ¤í‚¨ ë°°íŒ:
  <select id="skinCarryOn" onchange="calculateGame()">
    <option value="1" selected>ON</option>
    <option value="0">OFF</option>
  </select>

  ìŠ¤í‚¨ ìµœëŒ€í™€:
  <input id="skinMaxPayout" value="3" oninput="calculateGame()">

  <button onclick="resetScores()">â†º ë¦¬í”„ë ˆì‹œ (ìŠ¤ì½”ì–´ ì´ˆê¸°í™”)</button>
  <button onclick="captureScreen()">ğŸ“¸ ì „ì²´í™”ë©´ ìŠ¤í¬ë¦°ìƒ·</button>
</div>

<div class="note">
- íƒ€ë‹¹ ë°°íŒ: ì „ í™€ì—ì„œ <b>ë²„ë”” ì´ìƒ / íŠ¸ë¦¬í”Œ ì´ìƒ / ì „ì› ê°™ì€ ìŠ¤ì½”ì–´</b>ë©´, ë‹¤ìŒ í™€ íƒ€ë‹¹ì´ 2ë°°ê°€ ë©ë‹ˆë‹¤.<br>
- ìŠ¤í‚¨ ìµœëŒ€í™€: ìŠ¤í‚¨ ì´ì›”ì´ í•œ ë²ˆì— í„°ì§ˆ ìˆ˜ ìˆëŠ” ìµœëŒ€ í™€ ìˆ˜ì…ë‹ˆë‹¤.<br>
- ë²„ë””(íŒŒ-1)ëŠ” í•˜ëŠ˜ìƒ‰, ì´ê¸€(íŒŒ-2 ì´í•˜)ëŠ” ì£¼í™©ìƒ‰ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.<br>
- ìŠ¤í‚¨ ìƒ‰ í‘œì‹œ (v7, ìˆœì„œ ê¸°ì¤€): <b>ì´ë²ˆì— ì‹¤ì œë¡œ ë°›ì€ ìŠ¤í‚¨ ê°œìˆ˜ë§Œí¼, ìŒ“ì¸ ìˆœì„œëŒ€ë¡œ(ê°€ì¥ ë¨¼ì € ìŒ“ì¸ í™€ë¶€í„°)</b> ë³´ë¼ìƒ‰ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.<br>
  ì˜ˆ) 1,2,3 ì´ì›” í›„ 3ë²ˆí™€ì—ì„œ ì´ê¸°ë©´ â†’ 1,2,3ë²ˆí™€ ìƒ‰ì¹ .<br>
      4,5 ì´ì›” í›„ 5ë²ˆí™€ì—ì„œ ì´ê¸°ë©´ â†’ 4,5ë²ˆí™€ ìƒ‰ì¹ .<br>
      6,7,8,9,10 ì´ì›” í›„ 11ë²ˆí™€ì—ì„œ ìµœëŒ€ 3ê°œë§Œ ì§€ê¸‰ì´ë©´ â†’ 6,7,8ë²ˆí™€ ìƒ‰ì¹ , 9,10,11ì€ ë‹¤ìŒ ì´ì›”ë¡œ ë‚¨ìŠµë‹ˆë‹¤.
</div>

<br>
<div id="nameArea"></div>
<br>

<table id="scoreTable"></table>

<h3>18í™€ ëˆ„ì  ë¨¸ë‹ˆ ê²°ê³¼</h3>
<div id="totalResult"></div>

<h3>ì´ íŒŒ / ê° í”Œë ˆì´ì–´ ì´ íƒ€ìˆ˜</h3>
<div id="strokeResult"></div>

<script>
let players = 4;

function setupPlayers() {
  players = parseInt(document.getElementById("playerCount").value);

  let nameHTML = "";
  for (let i = 0; i < players; i++) {
    nameHTML += `Player ${i+1} ì´ë¦„: <input class="name-input" id="name${i}" value="Player ${i+1}" oninput="updateHeader()"> `;
  }
  document.getElementById("nameArea").innerHTML = nameHTML;

  buildTable();
  calculateGame();
}

function updateHeader(){
  buildTable(true);
  calculateGame();
}

function buildTable(keepScore=false) {
  const oldScores = {};
  if(keepScore){
    for(let h=1;h<=18;h++){
      for(let i=0;i<players;i++){
        const el = document.getElementById(`s${h}_${i}`);
        if(el) oldScores[`s${h}_${i}`] = el.value;
      }
    }
  }

  const tbl = document.getElementById("scoreTable");
  tbl.innerHTML = "";

  let header = "<tr><th rowspan='2'>í™€</th><th rowspan='2'>íŒŒ</th>";
  for (let i=0;i<players;i++){
    const nm = document.getElementById("name"+i)?.value || ("Player "+(i+1));
    header += `<th colspan='2'>${nm}</th>`;
  }
  header += "<th rowspan='2'>ì´ í™€ ì´ ì´ë™</th></tr>";

  header += "<tr>";
  for (let i=0;i<players;i++){
    header += "<th>íƒ€ìˆ˜</th><th>ê¸ˆì•¡</th>";
  }
  header += "</tr>";

  tbl.innerHTML += header;

  for (let h=1;h<=18;h++) {
    let row = `<tr><td>${h}</td><td><input id="par${h}" value="4" oninput="calculateGame()"></td>`;
    for (let i=0;i<players;i++) {
      row += `<td><input id="s${h}_${i}" oninput="calculateGame()"></td>`;
      row += `<td class="move" id="pm${h}_${i}">$0</td>`;
    }
    row += `<td class="move" id="move${h}">$0</td></tr>`;
    tbl.innerHTML += row;
  }

  if(keepScore){
    for(let key in oldScores){
      const el=document.getElementById(key);
      if(el) el.value=oldScores[key];
    }
  }
}

function clearSkinHighlights(){
  for(let h=1; h<=18; h++){
    for(let i=0; i<players; i++){
      const cell = document.getElementById(`pm${h}_${i}`);
      if(cell) cell.classList.remove("skinwin");
    }
  }
}

function calculateGame() {
  if (!document.getElementById("rate")) return;

  let baseRate = Number(document.getElementById("rate").value) || 0;
  let birdie = Number(document.getElementById("birdie").value) || 0;
  let eagle = Number(document.getElementById("eagle").value) || 0;
  let skin = Number(document.getElementById("skin").value) || 0;
  let carryOn = document.getElementById("skinCarryOn").value === "1";
  let maxPayout = Math.max(1, Number(document.getElementById("skinMaxPayout").value || 1));

  let totalMoney = new Array(players).fill(0);
  let totalStrokes = new Array(players).fill(0);
  let totalPar = 0;

  clearSkinHighlights();

  // ìŠ¤í‚¨ ì´ì›” ê´€ë¦¬ìš© í: ì•„ì§ ëˆ„êµ¬ì—ê²Œë„ ì§€ê¸‰ë˜ì§€ ì•Šì€ ìŠ¤í‚¨ì´ ìŒ“ì¸ í™€ ë²ˆí˜¸ë“¤
  let skinQueue = [];

  let nextRateMult = 1;

  for (let h=1;h<=18;h++) {
    const rateMult = nextRateMult;
    const holeRate = baseRate * rateMult;

    let par = Number(document.getElementById("par"+h).value) || 0;
    if (par > 0) totalPar += par;

    let scores = [];

    for (let i=0;i<players;i++) {
      let input = document.getElementById(`s${h}_${i}`);
      if (!input) continue;
      let val = Number(input.value || 0);
      scores.push(val);
      if (val > 0) totalStrokes[i] += val;

      input.classList.remove("birdie","eagle");
      if(par > 0){
        if(val === par-1) input.classList.add("birdie");
        if(val <= par-2 && val > 0) input.classList.add("eagle");
      }
    }
    if (scores.length < players) continue;

    let holeMoney = new Array(players).fill(0);

    // 1) íƒ€ìˆ˜ ì°¨ì´
    for (let i=0;i<players;i++) {
      for (let j=i+1;j<players;j++) {
        const diff = scores[i] - scores[j];
        if (diff > 0) {
          holeMoney[i] -= diff * holeRate;
          holeMoney[j] += diff * holeRate;
        } else if (diff < 0) {
          holeMoney[i] += Math.abs(diff) * holeRate;
          holeMoney[j] -= Math.abs(diff) * holeRate;
        }
      }
    }

    // 2) ë²„ë”” / ì´ê¸€
    if (par > 0){
      scores.forEach((s, i) => {
        if (s > 0 && s <= par - 2) { // ì´ê¸€ ì´ìƒ
          holeMoney[i] += eagle * (players - 1);
          for (let j=0;j<players;j++) if (j!==i) holeMoney[j] -= eagle;
        } else if (s === par - 1) { // ë²„ë””
          holeMoney[i] += birdie * (players - 1);
          for (let j=0;j<players;j++) if (j!==i) holeMoney[j] -= birdie;
        }
      });
    }

    // 3) ìŠ¤í‚¨
    if (par > 0){
      const positiveScores = scores.filter(x=>x>0);
      if (positiveScores.length === players){
        const min = Math.min(...positiveScores);
        const winCount = scores.filter(v => v === min).length;

        if (winCount === 1 && min <= par) {
          const winnerIdx = scores.indexOf(min);

          if (carryOn) {
            // ì´ë²ˆ í™€ ìŠ¤í‚¨ë„ íì— ë¨¼ì € ìŒ“ëŠ”ë‹¤
            skinQueue.push(h);
            const totalSkins = skinQueue.length;
            const payable = Math.min(totalSkins, maxPayout);

            if(payable > 0){
              holeMoney[winnerIdx] += skin * (players - 1) * payable;
              for (let j=0;j<players;j++) if (j!==winnerIdx) holeMoney[j] -= skin * payable;

              // ê°€ì¥ ë¨¼ì € ìŒ“ì¸ í™€ë¶€í„° payableê°œë§Œ ìƒ‰ì¹  & íì—ì„œ ì œê±° (FIFO)
              const paidHoles = skinQueue.slice(0, payable);
              skinQueue = skinQueue.slice(payable);   // ë‚˜ë¨¸ì§€ëŠ” ê³„ì† ì´ì›”
              paidHoles.forEach(hh => {
                const c = document.getElementById(`pm${hh}_${winnerIdx}`);
                if(c) c.classList.add("skinwin");
              });
            }
          } else {
            // ì´ì›” ì•ˆ í•˜ëŠ” ê²½ìš°: í˜„ì¬ í™€ë§Œ 1ê°œ ìŠ¤í‚¨
            holeMoney[winnerIdx] += skin * (players - 1);
            for (let j=0;j<players;j++) if (j!==winnerIdx) holeMoney[j] -= skin;

            const c = document.getElementById(`pm${h}_${winnerIdx}`);
            if(c) c.classList.add("skinwin");
          }
        } else {
          // ìŠ¹ì ì—†ê³  ì´ì›” ì¼œì ¸ ìˆì„ ë•Œë§Œ íì— ì¶”ê°€
          if (carryOn) {
            skinQueue.push(h);
          }
        }
      }
    }

    // 4) ê¸ˆì•¡ ë°˜ì˜ (skinwin í´ë˜ìŠ¤ëŠ” ìœ ì§€)
    let moveSum = 0;
    for (let i=0;i<players;i++){
      const cell = document.getElementById(`pm${h}_${i}`);
      if (!cell) continue;
      const money = holeMoney[i];
      cell.innerText = (money>=0?"+":"") + "$" + money.toFixed(0);
      cell.classList.remove("pos","neg");
      cell.classList.add(money>=0 ? "pos" : "neg");
      cell.classList.add("move");
      moveSum += Math.abs(money);
      totalMoney[i] += money;
    }

    const moveCell = document.getElementById("move"+h);
    if (moveCell) moveCell.innerText = "$" + (moveSum/2).toFixed(0);

    // 5) ë‹¤ìŒ í™€ íƒ€ë‹¹ ë°°íŒ ì—¬ë¶€
    let nextMult = 1;
    if (par > 0){
      const positiveScores2 = scores.filter(x=>x>0);
      if (positiveScores2.length === players){
        let hasBirdieOrBetter = scores.some(s => s>0 && s <= par-1);
        let hasTripleOrWorse = scores.some(s => s >= par+3);
        let allEqual = scores.every(s => s === scores[0] && s>0);
        if (hasBirdieOrBetter || hasTripleOrWorse || allEqual) {
          nextMult = 2;
        }
      }
    }
    nextRateMult = nextMult;
  }

  // 18í™€ ë¨¸ë‹ˆ ê²°ê³¼
  let resultHTML = "";
  for (let i=0;i<players;i++) {
    const nm = document.getElementById("name"+i)?.value || ("Player "+(i+1));
    resultHTML += nm + ": $" + totalMoney[i].toFixed(0) + "<br>";
  }
  document.getElementById("totalResult").innerHTML = resultHTML;

  // ì´ íŒŒ / ì´ íƒ€ìˆ˜
  let strokeHTML = "ì´ íŒŒ: " + totalPar + "<br>";
  for (let i=0;i<players;i++){
    const nm = document.getElementById("name"+i)?.value || ("Player "+(i+1));
    strokeHTML += nm + " ì´ íƒ€ìˆ˜: " + totalStrokes[i] + "<br>";
  }
  document.getElementById("strokeResult").innerHTML = strokeHTML;
}

function resetScores(){
  // íŒŒëŠ” 4ë¡œ ì´ˆê¸°í™”, ìŠ¤ì½”ì–´/ê¸ˆì•¡/ìƒ‰/ê²°ê³¼ ëª¨ë‘ ë¦¬ì…‹
  for(let h=1; h<=18; h++){
    const par = document.getElementById("par"+h);
    if(par) par.value = 4;
    for(let i=0; i<players; i++){
      const s = document.getElementById(`s${h}_${i}`);
      const pm = document.getElementById(`pm${h}_${i}`);
      if(s){
        s.value = "";
        s.classList.remove("birdie","eagle");
      }
      if(pm){
        pm.innerText = "$0";
        pm.classList.remove("pos","neg","skinwin");
        pm.classList.add("move");
      }
    }
    const mv = document.getElementById("move"+h);
    if(mv) mv.innerText = "$0";
  }
  document.getElementById("totalResult").innerHTML = "";
  document.getElementById("strokeResult").innerHTML = "";
}

async function captureScreen(){
  try{
    const stream = await navigator.mediaDevices.getDisplayMedia({ video: { frameRate: 30 } });
    const track = stream.getVideoTracks()[0];
    const imageCapture = new ImageCapture(track);
    const bitmap = await imageCapture.grabFrame();

    const canvas = document.createElement("canvas");
    canvas.width = bitmap.width;
    canvas.height = bitmap.height;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(bitmap, 0, 0);

    const link = document.createElement("a");
    link.href = canvas.toDataURL("image/png");
    link.download = "golf_score_screenshot.png";
    link.click();
    track.stop();
  } catch(e){
    alert("ìŠ¤í¬ë¦°ìƒ·ì„ ì‚¬ìš©í•˜ë ¤ë©´ í™”ë©´ ê³µìœ  ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.");
  }
}

setupPlayers();
</script>

</body>
</html>
